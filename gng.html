<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>ÆX Go-NoGo . Response Inhibition Task</title>

<style>
    body {
        background: #0d0d0d;
        color: #ffffff;
        font-family: Arial, sans-serif;
        text-align: center;
        padding-top: 80px;
        margin: 0;
    }

    h1 {
        font-size: 52px;
        margin-bottom: 30px;
    }

    h2 {
        font-size: 32px;
        margin-top: 10px;
        margin-bottom: 30px;
    }

    h3 {
        font-size: 22px;
        margin-top: 40px;
        margin-bottom: 15px;
    }

    #instructions {
        font-size: 20px;
        margin-bottom: 30px;
    }

    #letter {
        font-size: 100px;
        font-weight: bold;
        margin-bottom: 40px;
        min-height: 120px;
    }

    .btn {
        font-size: 24px;
        padding: 14px 32px;
        margin: 8px;
        background: #1b1b1b;
        border: 2px solid #5fffd2;
        color: #5fffd2;
        cursor: pointer;
        border-radius: 8px;
    }

    .btn:hover {
        background: #5fffd2;
        color: #000000;
    }

    #startBtn {
        margin-top: 30px;
    }

    #result {
        font-size: 20px;
        margin-top: 40px;
        line-height: 1.6;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        text-align: left;
    }

    #result p {
        margin: 6px 0;
    }

    #legend ul {
        text-align: left;
        display: inline-block;
        margin: 0;
        padding-left: 20px;
    }

    #legend li {
        margin-bottom: 6px;
    }

    .badge-container {
        margin-top: 25px;
        margin-bottom: 10px;
    }

    .badge-label {
        font-size: 18px;
        margin-bottom: 8px;
    }

    .badge-pill {
        display: inline-block;
        padding: 8px 18px;
        border-radius: 999px;
        font-size: 16px;
        font-weight: bold;
    }

    .badge-good {
        background-color: #1f8a70;
        color: #ffffff;
    }

    .badge-normal {
        background-color: #b38f1b;
        color: #000000;
    }

    .badge-high {
        background-color: #b3261e;
        color: #ffffff;
    }

    .note {
        font-size: 12px;
        margin-top: 35px;
        color: #cccccc;
        text-align: center;
    }
</style>
</head>

<body>

<h1>Go - No-Go Task</h1>

<div id="instructions">
    Premi "Inizia" per cominciare.<br>
    Premi la <strong>barra spaziatrice</strong> per ogni lettera <strong>Go</strong>.<br>
    Non premere nulla quando compare la lettera <strong>No-Go</strong>.
</div>

<button id="startBtn" class="btn">Inizia</button>

<div id="letter" style="display:none;"></div>

<div id="result"></div>

<script>
/* ------------------------------
   CONFIGURAZIONE
--------------------------------*/

// sostituisci con la URL della tua Web App Google Apps Script
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz6J2qmfY4Gra9hfEyEbd5NGqQnWLReAAKKafUD6tjqb9yY1wZW2p1md3zS5Q4PVUPBpQ/exec";

const NUM_TRIALS = 120;
const GO_PROB = 0.7;          // 70 percent Go, 30 percent No-Go
const STIM_MS = 500;
const ISI_MS = 1500;

const GO_LETTER = "X";
const NOGO_LETTER = "O";
const FILLER_LETTERS = "ABCDEFGHJKLMNPQRTUVWYZ".split("");

let trials = [];
let currentTrial = 0;
let trialStartTime = 0;
let respondedThisTrial = false;
let running = false;

/* tipo trial
   {
     index,
     letter,
     isGo,
     responded,
     rt,
     hit,
     omission,
     commission,
     correctInhibition
   }
*/

/* ------------------------------
   UTILITY
--------------------------------*/

function randomFiller() {
    return FILLER_LETTERS[Math.floor(Math.random() * FILLER_LETTERS.length)];
}

function avg(arr) {
    if (!arr.length) return 0;
    return arr.reduce((a, b) => a + b, 0) / arr.length;
}

function interpretGNG(hitRate, commissionErrors) {
    if (hitRate >= 0.85 && commissionErrors <= 5) {
        return {
            label: "Ottimo equilibrio tra velocità di risposta e controllo inibitorio",
            cssClass: "badge-good"
        };
    } else if (hitRate >= 0.7) {
        return {
            label: "Performance nella norma. possibili cali di controllo inibitorio sotto carico",
            cssClass: "badge-normal"
        };
    } else {
        return {
            label: "In questo test emergono risposte impulsive o difficoltà nel bloccare l'azione",
            cssClass: "badge-high"
        };
    }
}

/* ------------------------------
   AVVIO TEST
--------------------------------*/

document.getElementById("startBtn").onclick = () => {
    document.getElementById("instructions").style.display = "none";
    document.getElementById("startBtn").style.display = "none";

    document.getElementById("letter").style.display = "block";

    window.addEventListener("keydown", handleKeydown);
    running = true;
    nextTrial();
};

/* ------------------------------
   TASTIERA
--------------------------------*/

function handleKeydown(e) {
    if (!running) return;
    if (e.code !== "Space" && e.key !== " ") return;
    if (respondedThisTrial) return;

    respondedThisTrial = true;
    const rt = Math.round(performance.now() - trialStartTime);

    const t = trials[currentTrial - 1];
    t.responded = true;
    t.rt = rt;

    if (t.isGo) {
        t.hit = true;
        t.omission = false;
        t.commission = false;
        t.correctInhibition = false;
    } else {
        t.hit = false;
        t.omission = false;
        t.commission = true;
        t.correctInhibition = false;
    }
}

/* ------------------------------
   NUOVO TRIAL
--------------------------------*/

function nextTrial() {
    if (currentTrial >= NUM_TRIALS) {
        finishTest();
        return;
    }

    respondedThisTrial = false;

    // decide Go o No-Go
    const isGo = Math.random() < GO_PROB;

    let letter;
    if (isGo) {
        letter = GO_LETTER;
    } else {
        // usiamo una vera lettera No-Go
        letter = NOGO_LETTER;
    }

    const letterDiv = document.getElementById("letter");
    letterDiv.innerHTML = letter;

    trialStartTime = performance.now();

    trials.push({
        index: currentTrial + 1,
        letter: letter,
        isGo: isGo,
        responded: false,
        rt: null,
        hit: false,
        omission: false,
        commission: false,
        correctInhibition: false
    });

    currentTrial++;

    setTimeout(() => {
        letterDiv.innerHTML = "";
        // chiudiamo il trial dopo ISI
        setTimeout(() => {
            const t = trials[currentTrial - 1];

            if (t.isGo && !t.responded) {
                t.omission = true;
            }
            if (!t.isGo && !t.responded) {
                t.correctInhibition = true;
            }

            nextTrial();
        }, ISI_MS);
    }, STIM_MS);
}

/* ------------------------------
   FINE TEST
--------------------------------*/

function finishTest() {
    running = false;
    window.removeEventListener("keydown", handleKeydown);
    document.getElementById("letter").style.display = "none";

    let goCount = 0;
    let nogoCount = 0;
    let hits = 0;
    let omissions = 0;
    let commissions = 0;
    let correctInhibitions = 0;
    let rtsHits = [];

    trials.forEach(t => {
        if (t.isGo) goCount++;
        else nogoCount++;

        if (t.hit) {
            hits++;
            if (t.rt != null) rtsHits.push(t.rt);
        }
        if (t.omission) omissions++;
        if (t.commission) commissions++;
        if (t.correctInhibition) correctInhibitions++;
    });

    const hitRate = goCount > 0 ? hits / goCount : 0;
    const hitPercent = Math.round(hitRate * 100);
    const commissionPercent = nogoCount > 0 ? Math.round((commissions / nogoCount) * 100) : 0;
    const meanRtHits = rtsHits.length ? Math.round(avg(rtsHits)) : 0;

    const sessionId = "AEX-" + Date.now();
    const interpretation = interpretGNG(hitRate, commissions);

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = `
        <h2>Risultati</h2>

        <p><strong>Tempo medio di risposta ai Go corretti. </strong>${meanRtHits || "-"} ms</p>
        <p><strong>Numero totale trial Go. </strong>${goCount}</p>
        <p><strong>Numero totale trial No-Go. </strong>${nogoCount}</p>
        <p><strong>Hit (risposte corrette ai Go). </strong>${hits}</p>
        <p><strong>Errori di omissione (no risposta a Go). </strong>${omissions}</p>
        <p><strong>Errori di commissione (risposta a No-Go). </strong>${commissions}</p>
        <p><strong>Accuratezza sui Go. </strong>${hitPercent} percent</p>
        <p><strong>Percentuale errori su No-Go. </strong>${commissionPercent} percent</p>

        <div class="badge-container">
            <div class="badge-label">Sintesi del tuo profilo in questo test</div>
            <div class="badge-pill ${interpretation.cssClass}">
                ${interpretation.label}
            </div>
        </div>

        <div id="legend">
            <h3>Come leggere questi dati</h3>
            <ul>
                <li>Il Go-NoGo misura la capacità di avviare rapidamente una risposta e bloccarla quando non è più appropriata.</li>
                <li>Molti errori di omissione possono indicare rallentamenti o cali di vigilanza.</li>
                <li>Molti errori di commissione possono indicare impulsività o difficoltà a inibire risposte automatiche.</li>
            </ul>
        </div>

        <p class="note">
            I dati di questo test sono salvati in forma anonima e aggregata.  
            non raccogliamo nome, email o altri dati che permettano l'identificazione personale.  
            il tuo codice di sessione è <strong>${sessionId}</strong> e viene usato solo per analisi statistiche interne.
        </p>
    `;

    const payload = {
        sessionId,
        totalTrials: NUM_TRIALS,
        goCount,
        nogoCount,
        hits,
        omissions,
        commissions,
        correctInhibitions,
        hitPercent,
        commissionPercent,
        meanRtHits,
        extra: ""
    };

    fetch(WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain" },
        body: JSON.stringify(payload)
    }).catch(err => {
        console.error("Errore nell'invio al foglio Google:", err);
    });
}
</script>

</body>
</html>
